#compdef browse

_browse_completions() {
  typeset -A BROWSE_OPTIONS
  BROWSE_OPTIONS[gcloud_logs]='-project -query'
  BROWSE_OPTIONS[gcloud_bigquery]='-project'
  BROWSE_OPTIONS[gcloud_spanner]='-project -instance -database'
  BROWSE_OPTIONS[github_default]='-org -repository'

  local cur prev service subservice
  cur=${words[CURRENT]}
  prev=${words[CURRENT-1]}
  service=${words[2]}
  subservice=${words[3]}

  # まず値補完
  case $prev in
    -project)
      compadd $(gcloud projects list --format="value(projectId)")
      return
      ;;
    -instance)
      compadd $(gcloud spanner instances list --format="value(name)")
      return
      ;;
    -database)
      if [[ -n $words[4] ]]; then
        compadd $(gcloud spanner databases list --instance=${words[4]} --format="value(name)")
      fi
      return
      ;;
    -org)
      compadd my-org
      return
      ;;
    -repository)
      compadd my-repo
      return
      ;;
  esac

  # service 補完（最初の引数）
  if [[ $CURRENT -eq 2 ]]; then
    compadd gcloud github
    return
  fi

  # subservice 補完（gcloud の場合）
  if [[ $service == "gcloud" && $CURRENT -eq 3 ]]; then
    compadd logs bigquery spanner
    return
  fi

  # オプション補完
  if [[ $CURRENT -ge 4 ]]; then
    local key
    if [[ $service == "github" ]]; then
        key="github_default"
    else
        key="${service}_${subservice}"
    fi
    
    compadd -- "${(ps: :)BROWSE_OPTIONS[$key]}"
    return
  fi
}

compdef _browse_completions browse